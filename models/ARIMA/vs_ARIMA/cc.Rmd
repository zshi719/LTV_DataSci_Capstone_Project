---
title: "Time Series"
output: html_document
date: "2023-11-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggfortify)
library(forecast)
```

# Data importing and cleaning

We firstly load the data and convert the confirmed cases to ts objects:

```{r}
df = read.csv("s_train.csv", row.names = 1)
df <- df[50:191,]
confirmed <- ts(df$confirmed, start = c(4, 4), frequency = 7)
confirmed
```

# Data visualization

The plot of confirmed cases clearly are not stationary and there is some seasonality.

```{r}
autoplot(confirmed) +
  ylab("Retail index") +
  xlab("Week")
```


a seasonal difference and the plot of resulting series, ACF and PACF are illustrated in the figure below.

```{r}
confirmed %>% diff(lag = 7) %>% ggtsdisplay()
```



```{r}
confirmedDe <- decompose(confirmed)
my_plot.decomposed.ts(confirmedDe, "Decomposed Time Series", lty = 1, cex = 2)
confirmed %>%
  diff(lag = 7) %>%
  diff() %>%
  ggtsdisplay()
```


# Seasonal ARIMA






We run the `auto.arima` function to see which setup of the model gives the lowest AIC and BIC:



We see that model $ARIMA(2,1,2)(0,0,1)_7$ gives the lowest AIC and BIC. We can plot the residuals and conduct Ljung-Box test:

```{r}

fit1 <- Arima(confirmed, order = c(2, 1, 2), seasonal = c(0, 0, 1))
checkresiduals(fit1)
df_test <- read.csv("s_test.csv", row.names = 1)
confirmed_test <- ts(df_test$confirmed, start = c(31, 6), frequency = 7)

pred = data.frame(forecast(fit1, h = 48))[, 1]

mean(abs(pred - confirmed_test))
```



```{r}
df_test <- read.csv("s_test.csv", row.names = 1)
confirmed_test <- ts(df_test$confirmed, start = c(31, 6), frequency = 7)

pred = data.frame(forecast(fit1, h = 48))[, 1]

mean(abs(pred - confirmed_test))
```

# Forecasting

Load the test data:

```{r}
df_test <- read.csv("s_test.csv", row.names = 1)
confirmed_test <- ts(df_test$confirmed, start = c(31, 6), frequency = 7)
confirmed_test
```

```{r}
fit1 %>% forecast(h = 48) %>% autoplot()
```

Compute RMSE for test data:

```{r}
pred = data.frame(forecast(fit2, h = 48))[, 1]
# RMSE
sqrt(mean((pred - confirmed_test)^2))

mean(abs(pred - confirmed_test))
```
```{r}
mean(abs(pred - confirmed_test))
```


